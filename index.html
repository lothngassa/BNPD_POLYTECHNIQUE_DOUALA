<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BNPD - Biblioth√®que Num√©rique Polytechnique Douala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-animate {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        /* D√©lai d'animation pour un effet escalier */
        .card-animate:nth-child(1) { animation-delay: 0.1s; }
        .card-animate:nth-child(2) { animation-delay: 0.15s; }
        .card-animate:nth-child(3) { animation-delay: 0.2s; }
        .card-animate:nth-child(4) { animation-delay: 0.25s; }
        .card-animate:nth-child(5) { animation-delay: 0.3s; }
        .card-animate:nth-child(6) { animation-delay: 0.35s; }
        .card-animate:nth-child(7) { animation-delay: 0.4s; }
        .card-animate:nth-child(8) { animation-delay: 0.45s; }
        .card-animate:nth-child(9) { animation-delay: 0.5s; }
        .card-animate:nth-child(10) { animation-delay: 0.55s; }
        .card-animate:nth-child(11) { animation-delay: 0.6s; }
        .card-animate:nth-child(12) { animation-delay: 0.65s; }

        .hidden { display: none; }

        /* Style pour le tag de filtre actif */
        .filter-tag.active-tag {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
            border-color: #4f46e5;
            font-weight: 600;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Overlay pour la Sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-20 hidden"></div>
    <!-- Sidebar -->
    <nav id="sidebar" class="fixed top-0 left-0 w-80 h-full bg-white shadow-xl z-30 transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="p-5 border-b">
            <h2 class="text-xl font-bold text-indigo-700">Fili√®res (ENSPD)</h2>
        </div>
        <div id="sidebar-links" class="flex flex-col p-4 space-y-2 flex-1 overflow-y-auto">
            <a href="#" data-filiere="GIT" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 font-medium">G√©nie Informatique et t√©l√©com (GIT)</a>
            <a href="#" data-filiere="GCI" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 font-medium">G√©nie Civil (GCI)</a>
            <a href="#" data-filiere="GPH" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 font-medium">G√©nie Physique (GPH)</a>
            <a href="#" data-filiere="GM" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 font-medium">G√©nie M√©canique (GM)</a>
            <a href="#" data-filiere="GE" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 font-medium">G√©nie √ânerg√©tique (GE)</a>
            <a href="#" data-filiere="GP" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 font-medium">G√©nie des Proc√©d√©s (GP)</a>
            <a href="#" data-filiere="GMP" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 font-medium">G√©nie Maritime et Portuaire (GMP)</a>
            <a href="#" data-filiere="GAM" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 font-medium">G√©nie Automobile et M√©catronique (GAM)</a>
            <a href="#" data-filiere="QHSE" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 font-medium">QHSE</a>
            <a href="#" data-filiere="MP" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 font-medium">Master Professionnel (MP)</a>
        </div>
    </nav>

    <!-- Header / Barre de Navigation -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            
            <div class="flex items-center space-x-3">
                <button id="burger-btn" class="p-2 rounded-md text-gray-700 hover:bg-gray-100">
                    <!-- Icone Menu -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                </button>
                <img src="logo.png" onerror="this.onerror=null;this.src='https://placehold.co/40x40/4f46e5/ffffff?text=Logo'" alt="Logo ENSPD" class="h-8 w-auto sm:h-10">
            </div>

            <h1 class="text-lg sm:text-xl font-bold text-indigo-700 text-center truncate flex-1">
                Biblioth√®que Num√©rique <span class="hidden sm:inline-block">Polytechnique Douala (BNPD)</span>
            </h1>

            <!-- Actions Utilisateur -->
            <div class="flex items-center space-x-2 sm:space-x-4">
                <a href="submit.html" class="bg-gradient-to-r from-indigo-600 to-blue-500 text-white px-3 sm:px-4 py-2 rounded-lg font-semibold hover:from-indigo-700 hover:to-blue-600 transition duration-300 shadow-lg shadow-indigo-400/50 flex items-center text-sm sm:text-base">
                    <!-- Icone Upload -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0.0 0.0 24.0 24.0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-0 sm:mr-2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                    <span class="hidden sm:inline-block">T√©l√©verser</span>
                </a>
                <button class="p-2 rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-600 transition duration-300">
                    <!-- Icone Utilisateur -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0.0 0.0 24.0 24.0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Contenu Principal -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        
        <!-- Section Recherche et Filtres -->
        <section class="text-center mb-12">
            <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-4 leading-snug">
                Bienvenue sur la plateforme des m√©moires
            </h2>
            <p class="text-lg text-gray-600 mb-8 max-w-2xl mx-auto">
                de l'Ecole Nationale Sup√©rieure Polytechnique de Douala
            </p>

            <div class="flex flex-col sm:flex-row items-stretch sm:items-center max-w-4xl mx-auto space-y-4 sm:space-y-0 sm:space-x-4">
                <!-- Champ de Recherche -->
                <div class="relative flex-grow shadow-xl rounded-xl">
                    <input type="text" id="search-input" placeholder="Rechercher par Th√®me, titre, nom de l'√©tudiant, Matricule..." 
                        class="w-full pl-12 pr-4 py-4 border-2 border-indigo-200 rounded-xl focus:outline-none focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 text-lg transition duration-300">
                    <!-- Icone Loupe -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0.0 0.0 24.0 24.0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </div>
                
                <!-- Bouton et Dropdown Filtres -->
                <div class="relative">
                    <button id="filter-toggle-btn" class="w-full sm:w-auto bg-white border-2 border-gray-300 text-gray-800 px-6 py-4 rounded-xl font-semibold hover:bg-gray-50 hover:border-gray-400 transition duration-300 flex items-center justify-center text-lg whitespace-nowrap shadow-sm">
                        <!-- Icone Filtre -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0.0 0.0 24.0 24.0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2">
                            <path d="M3 6h18M7 12h10M10 18h4"/>
                        </svg>
                        Filtres
                    </button>
                    <!-- Dropdown des filtres -->
                    <div id="filter-dropdown" class="absolute right-0 mt-2 w-80 bg-white border border-gray-200 rounded-xl shadow-lg p-5 z-10 hidden">
                        <div class="space-y-4">
                            <div>
                                <label for="filter-filiere" class="block text-sm font-medium text-gray-700 mb-1">Fili√®re</label>
                                <select id="filter-filiere" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Toutes les fili√®res</option>
                                    <option value="GIT">GIT</option>
                                    <option value="GCI">GCI</option>
                                    <option value="GPH">GPH</option>
                                    <option value="GM">GM</option>
                                    <option value="GE">GE</option>
                                    <option value="GP">GP</option>
                                    <option value="GMP">GMP</option>
                                    <option value="GAM">GAM</option>
                                    <option value="QHSE">QHSE</option>
                                    <option value="MP">MP</option>
                                </select>
                            </div>
                            <div>
                                <label for="filter-annee" class="block text-sm font-medium text-gray-700 mb-1">Ann√©e</label>
                                <select id="filter-annee" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Toutes les ann√©es</option>
                                    <!-- Options g√©n√©r√©es par JS -->
                                    </select>
                            </div>
                            <div>
                                <label for="filter-matricule" class="block text-sm font-medium text-gray-700 mb-1">Matricule</label>
                                <input type="text" id="filter-matricule" placeholder="Ex: 21G..." class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <button id="apply-filter-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300">
                                Appliquer les filtres
                            </button>
                        </div>
                    </div>
                </div>

            </div>
            
            <!-- Tags de Filtre Rapide -->
            <div id="quick-filters" class="mt-8 flex flex-wrap justify-center gap-3">
                <span class="filter-tag bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-full cursor-pointer text-sm font-medium shadow-sm hover:border-indigo-400" data-filiere="GIT">#GIT</span>
                <span class="filter-tag bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-full cursor-pointer text-sm font-medium shadow-sm hover:border-indigo-400" data-filiere="GCI">#GCI</span>
                <span class="filter-tag bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-full cursor-pointer text-sm font-medium shadow-sm hover:border-indigo-400" data-filiere="GPH">#GPH</span>
                <span class="filter-tag bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-full cursor-pointer text-sm font-medium shadow-sm hover:border-indigo-400" data-filiere="GM">#GM</span>
                <span class="filter-tag bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-full cursor-pointer text-sm font-medium shadow-sm hover:border-indigo-400" data-filiere="GE">#GE</span>
                <span class="filter-tag bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-full cursor-pointer text-sm font-medium shadow-sm hover:border-indigo-400" data-filiere="GP">#GP</span>
                <span class="filter-tag bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-full cursor-pointer text-sm font-medium shadow-sm hover:border-indigo-400" data-filiere="GMP">#GMP</span>
                <span class="filter-tag bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-full cursor-pointer text-sm font-medium shadow-sm hover:border-indigo-400" data-filiere="GAM">#GAM</span>
                <span class="filter-tag bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-full cursor-pointer text-sm font-medium shadow-sm hover:border-indigo-400" data-filiere="QHSE">#QHSE</span>
                <span class="filter-tag bg-white text-indigo-700 border border-indigo-200 px-4 py-2 rounded-full cursor-pointer text-sm font-medium shadow-sm hover:border-indigo-400" data-filiere="MP">#MP</span>
            </div>
        </section>

        <!-- Section des R√©sultats -->
        <section class="mt-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">
                M√©moires R√©cents (<span id="results-count">0</span>)
            </h3>

            <div id="card-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                <!-- Les cartes de m√©moires seront ins√©r√©es ici par JS -->
            </div>
            
            <div class="text-center mt-10">
                <button class="bg-indigo-50 border-2 border-indigo-200 text-indigo-700 px-8 py-3 rounded-xl font-semibold hover:bg-indigo-100 hover:shadow-lg transition duration-300 shadow-md">
                    Afficher plus de r√©sultats
                </button>
            </div>
        </section>

    </main>

    <script type="module">
        // --- √âl√©ments du DOM (UI) ---
        const burgerBtn = document.getElementById('burger-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const filterBtn = document.getElementById('filter-toggle-btn');
        const filterDropdown = document.getElementById('filter-dropdown');
        
        // --- √âl√©ments du DOM (Filtrage et Donn√©es) ---
        const cardGrid = document.getElementById('card-grid');
        const resultsCountSpan = document.getElementById('results-count');
        const searchInput = document.getElementById('search-input');
        const filiereDropdown = document.getElementById('filter-filiere');
        const anneeDropdown = document.getElementById('filter-annee');
        const matriculeInput = document.getElementById('filter-matricule');
        const applyFilterBtn = document.getElementById('apply-filter-btn');
        const quickFilterTags = document.querySelectorAll('#quick-filters .filter-tag');
        const sidebarLinks = document.querySelectorAll('#sidebar-links a[data-filiere]');

        // Stockage global des m√©moires charg√©s depuis l'API
        let allMemoires = [];
        
        // Mappage pour afficher le nom complet de la fili√®re
        const filiereMapping = {
            'GIT': 'G√©nie Informatique et t√©l√©com',
            'GCI': 'G√©nie Civil',
            'GPH': 'G√©nie Physique',
            'GM': 'G√©nie M√©canique',
            'GE': 'G√©nie √ânerg√©tique',
            'GP': 'G√©nie des Proc√©d√©s',
            'GMP': 'G√©nie Maritime et Portuaire',
            'GAM': 'G√©nie Automobile et M√©catronique',
            'QHSE': 'QHSE',
            'MP': 'Master Professionnel'
        };

        // Mappage de couleurs pour les badges de fili√®re
        const filiereColorMapping = {
            'GIT': { bg: 'bg-indigo-100', text: 'text-indigo-800' },
            'GCI': { bg: 'bg-green-100', text: 'text-green-800' },
            'GPH': { bg: 'bg-red-100', text: 'text-red-800' },
            'GM': { bg: 'bg-yellow-100', text: 'text-yellow-800' },
            'GE': { bg: 'bg-blue-100', text: 'text-blue-800' },
            'GP': { bg: 'bg-purple-100', text: 'text-purple-800' },
            'GMP': { bg: 'bg-pink-100', text: 'text-pink-800' },
            'GAM': { bg: 'bg-orange-100', text: 'text-orange-800' },
            'QHSE': { bg: 'bg-teal-100', text: 'text-teal-800' },
            'MP': { bg: 'bg-gray-100', text: 'text-gray-800' }
        };

        // --- Gestion de la Sidebar (Menu Burger) ---
        if (burgerBtn && sidebar && overlay) {
            burgerBtn.addEventListener('click', () => {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            });
            overlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            });
        }

        // --- Gestion du Dropdown des Filtres ---
        if (filterBtn && filterDropdown) {
            filterBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                filterDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (filterDropdown && !filterDropdown.classList.contains('hidden') && !filterDropdown.contains(e.target) && !filterBtn.contains(e.target)) {
                    filterDropdown.classList.add('hidden');
                }
            });
        }

        // ----------------------------------------------------
        // LOGIQUE DYNAMIQUE
        // ----------------------------------------------------

        /**
         * Mise √† jour: Ajout de la gestion de l'√©tat des quick filters lors du changement manuel du dropdown.
         */
        function updateQuickFilters(selectedFiliere) {
            quickFilterTags.forEach(tag => {
                if (tag.dataset.filiere === selectedFiliere) {
                    tag.classList.add('active-tag');
                } else {
                    tag.classList.remove('active-tag');
                }
            });
        }


        /**
         * G√©n√®re dynamiquement la liste des ann√©es de 2020 √† l'ann√©e la plus r√©cente trouv√©e dans les donn√©es (maxAnnee).
         */
        function populateAnneeFilter(maxAnnee) {
            const startYear = 2020; // D√©but fixe √† 2020, comme demand√©
            const endYear = maxAnnee; 

            // Efface toutes les options sauf la premi√®re ("Toutes les ann√©es")
            anneeDropdown.innerHTML = '<option value="">Toutes les ann√©es</option>'; 
            
            // Boucle pour ajouter les ann√©es de la plus r√©cente √† la plus ancienne
            for (let year = endYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                anneeDropdown.appendChild(option);
            }
        }


        /**
         * 1. Cr√©e le HTML pour une seule carte m√©moire
         */
        function createCardHTML(memoire) {
            // üí° V√©rification robuste des champs de l'API (pour √©viter 'undefined')
            const matricule = memoire.matricule || memoire.student_id || 'N/A'; 
            const axeRecherche = memoire.axe_recherche || memoire.axe || ''; 
            
            const dateSoumissionField = memoire.date_soumission || memoire.date_created || memoire.pub_date || null;
            
            const dateSoumission = dateSoumissionField 
                ? new Date(dateSoumissionField).toLocaleDateString('fr-FR') 
                : 'N/A';
            
            // Utilise l'ID du m√©moire pour g√©n√©rer un lien vers une page de d√©tail (m√™me si elle n'existe pas encore, c'est une bonne pratique)
            const pdfUrl = `https://bn-polytechnique-douala-api.onrender.com${memoire.fichier_pdf}`;
            const fullFiliereName = filiereMapping[memoire.filiere] || memoire.filiere;
            
            const colors = filiereColorMapping[memoire.filiere] || { bg: 'bg-gray-100', text: 'text-gray-800' };

            const axeHtml = axeRecherche 
                ? `<p class="text-xs text-indigo-500 mt-1 mb-2 font-semibold">Axe: ${axeRecherche}</p>` 
                : ''; 
            

            return `
                <div class="group card-animate bg-white p-5 rounded-xl shadow-lg border border-gray-100 hover:shadow-2xl hover:border-indigo-200 transition-all duration-300 transform hover:-translate-y-1 flex flex-col justify-between" 
                    data-filiere="${memoire.filiere}" 
                    data-annee="${memoire.annee}">
                    
                    <div>
                        <span class="text-xs font-semibold uppercase tracking-wider ${colors.text} ${colors.bg} px-3 py-1 rounded-full">${fullFiliereName}</span>
                        
                        <a href="detail.html?id=${memoire.id}" class="block hover:text-indigo-600 transition-colors">
                            <h4 class="text-lg font-bold text-gray-900 mt-2 mb-1 leading-snug">
                                ${memoire.titre}
                            </h4>
                        </a>
                        
                        ${axeHtml}
                        <p class="text-sm text-gray-500"><span class="font-medium text-gray-700">Auteur(s) :</span> ${memoire.auteur}</p>
                        <p class="text-sm text-gray-500"><span class="font-medium text-gray-700">Matricule :</span> ${matricule}</p>
                        <p class="text-sm text-gray-500"><span class="font-medium text-gray-700">Ann√©e :</span> ${memoire.annee}</p>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                        <span class="text-xs text-gray-500 font-bold">Publi√© le: ${dateSoumission}</span>
                        <a href="${pdfUrl}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white rounded-full px-3 py-1 transition-all duration-300 font-semibold flex items-center text-sm">
                            T√©l√©charger
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0.0 0.0 24.0 24.0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 ml-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </a>
                    </div>
                </div>
            `;
        }

        /**
         * 2. Affiche les m√©moires filtr√©s dans la grille
         */
        function renderCards(memoiresToRender) {
            if (memoiresToRender.length === 0) {
                cardGrid.innerHTML = '<p class="text-center text-slate-500 py-10 col-span-full">Aucun m√©moire ne correspond √† vos crit√®res.</p>';
            } else {
                cardGrid.innerHTML = memoiresToRender.map(createCardHTML).join('');
            }
            resultsCountSpan.textContent = memoiresToRender.length;
        }

        /**
         * 3. Fonction de filtrage principale
         */
        function filterMemoires() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedFiliere = filiereDropdown.value; // Source of truth for filiere
            const selectedAnnee = anneeDropdown.value;
            const selectedMatricule = matriculeInput.value.toLowerCase(); 

            // IMPORTANT: Synchronise les tags rapides avec l'√©tat du dropdown apr√®s tout filtre
            updateQuickFilters(selectedFiliere);
            
            const filteredMemoires = allMemoires.filter(memoire => {
                const filiereMatch = (selectedFiliere === "" || memoire.filiere === selectedFiliere);
                const anneeMatch = (selectedAnnee === "" || memoire.annee.toString() === selectedAnnee);

                // On rend le matricule plus robuste pour le filtrage
                const matriculeValue = memoire.matricule || memoire.student_id || '';

                const textMatch = (
                    memoire.titre.toLowerCase().includes(searchTerm) ||
                    memoire.auteur.toLowerCase().includes(searchTerm) ||
                    (memoire.axe_recherche && memoire.axe_recherche.toLowerCase().includes(searchTerm)) ||
                    matriculeValue.toLowerCase().includes(searchTerm) // Ajout du matricule dans la recherche g√©n√©rale
                );
                
                const matriculeMatch = (selectedMatricule === "" || matriculeValue.toLowerCase().includes(selectedMatricule));

                return filiereMatch && anneeMatch && textMatch && matriculeMatch;
            }).sort((a, b) => {
                 // Tri par ann√©e d√©croissante
                return parseInt(b.annee) - parseInt(a.annee);
            });

            renderCards(filteredMemoires);

            if (filterDropdown) filterDropdown.classList.add('hidden');
        }

        /**
         * 4. Charge les m√©moires depuis l'API au d√©marrage
         */
        async function loadMemoires() {
            cardGrid.innerHTML = '<p class="text-center text-slate-500 py-10 col-span-full">Chargement des m√©moires...</p>';
            resultsCountSpan.textContent = '...';

            // Fonction utilitaire pour l'exponential backoff
            const fetchWithRetry = async (url, options, maxRetries = 5) => {
                let lastError = null;
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            throw new Error(`Erreur HTTP: ${response.status}`);
                        }
                        return response;
                    } catch (error) {
                        lastError = error;
                        const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s, 8s...
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                throw lastError;
            };

            try {
                // L'adresse de votre API sur Render
                const response = await fetchWithRetry('https://bn-polytechnique-douala-api.onrender.com/api/memoires/');
                
                const data = await response.json();

                // Sortir les donn√©es par d√©faut avant de les stocker
                allMemoires = data.sort((a, b) => {
                    return parseInt(b.annee) - parseInt(a.annee);
                });
                
                // üí° LOGIQUE AJOUT√âE: Calcule l'ann√©e maximale pr√©sente dans les m√©moires
                const currentYear = new Date().getFullYear();
                const maxAnnee = allMemoires.reduce((max, memoire) => {
                    // S'assure que l'ann√©e est un nombre
                    const annee = parseInt(memoire.annee, 10);
                    // On filtre les ann√©es invalides (NaN)
                    if (isNaN(annee)) return max;
                    return (annee > max) ? annee : max;
                }, 2020); // Commence la r√©duction √† 2020 ou √† l'ann√©e courante

                // Assure que l'ann√©e maximale affich√©e est au moins l'ann√©e actuelle si aucune donn√©e plus r√©cente n'est trouv√©e
                const finalMaxAnnee = Math.max(maxAnnee, currentYear);

                // üí° UTILISE l'ann√©e maximale trouv√©e pour mettre √† jour la liste des options d'ann√©e
                populateAnneeFilter(finalMaxAnnee);

                renderCards(allMemoires); 

            } catch (error) {
                console.error("Erreur de chargement des m√©moires:", error);
                cardGrid.innerHTML = '<p class="text-center text-red-500 py-10 col-span-full">√âchec du chargement des donn√©es. Veuillez v√©rifier que l\'API est accessible.</p>';
                resultsCountSpan.textContent = 0;
            }
        }

        // ----------------------------------------------------
        // ATTACHE DES √âCOUTEURS D'√âV√âNEMENTS
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            loadMemoires(); 
            
            // √âcouteur pour la recherche en temps r√©el
            searchInput.addEventListener('input', filterMemoires);

            // √âcouteur pour l'application des filtres via le bouton
            applyFilterBtn.addEventListener('click', filterMemoires);
            
            // √âcouteur pour le changement de s√©lection dans le dropdown de fili√®re
            filiereDropdown.addEventListener('change', () => {
                // S'assure que le filtre rapide est synchronis√©
                updateQuickFilters(filiereDropdown.value);
                // Applique le filtre imm√©diatement au changement pour une meilleure UX
                filterMemoires();
            });

            // √âcouteur pour les tags de filtre rapide
            quickFilterTags.forEach(tag => {
                tag.addEventListener('click', () => {
                    const filiere = tag.dataset.filiere;

                    if (tag.classList.contains('active-tag')) {
                        // D√©sactive le filtre
                        filiereDropdown.value = ""; 
                    } else {
                        // Active le nouveau filtre
                        filiereDropdown.value = filiere; 
                    }
                    // Le changement de filiereDropdown.value d√©clenchera filterMemoires() via l'√©couteur 'change' s'il √©tait actif,
                    // mais nous le d√©clenchons ici explicitement aussi pour les cas o√π le 'change' ne se d√©clenche pas (comme dans le cas de la suppression).
                    filterMemoires(); 
                });
            });

            // √âcouteur pour les liens de la sidebar
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    const filiere = e.currentTarget.dataset.filiere;

                    // 1. Met √† jour le dropdown de fili√®re (Source de V√©rit√©)
                    filiereDropdown.value = filiere;

                    // 2. Synchronise les tags rapides
                    updateQuickFilters(filiere);

                    // 3. Applique les filtres
                    filterMemoires();

                    // 4. Ferme la sidebar
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                });
            });
        });

    </script>
</body>
</html>
